const data = {
  ogun: {
    "Ijebu Ode": {
      "Ward-1": [
        "001-Beside Co-Operative Building (Existing)",
        "002-Emmanuel School I, Italupe (Existing)",
        "003-Moslem School, Isoku (Existing)",
        "004-Front of Talabi’s House, Olisa Street I (Existing)",
        "005-Imoru Road Junction (Existing)",
        "006-Oke-Ola Ilorin (Existing)",
        "007-Emmanuel School II (Existing)",
        "008-Front of Talabi’s House, Olisa Street II (Existing)",
        "009-Adjacent A. B Sunmola House, Ijagun Road (New)",
        "010-Beside 3A’s Hotel, Imoru Road (New)",
        "011-Moslem School II, Ondo Road (New)"
      ],
      "Ward-2": [
        "001-Baptist Day School, Ereko (Existing)",
        "002-Front of Our Lady’s School (Existing)",
        "003-Front of Alhaji Kukoyi’s House (Existing)",
        "004-Opposite Itajana Mosque (Existing)",
        "005-State Hospital (Existing)",
        "006-Dental Centre (Existing)",
        "007-By Odo Esa Premier Mosque Near Idiroko, Olisa (New)",
        "008-Saka Ashiru Junction via Mayomayo (New)",
        "009-Open Space by Olorungbebe Mosque (New)",
        "010-Jimileyin Junction, Adjacent Irepodun Mosque (New)",
        "011-Open Space at Oguntuga Four Junction (New)"
      ],
      "Ward-3": [
        "001-Moslem School, Etitale I (Existing)",
        "002-Opposite Oloritun’s House (Existing)",
        "003-Front of Igboburo Mosque (Existing)",
        "004-Front of Balogun Kuku’s House (Existing)",
        "005-Isokun / Itaogbe Junction (Existing)",
        "006-Moslem School, Etitale II (Existing)",
        "007-Ahmadiyah Movement B/S, Araromi (New)"
      ],
      "Ward-4": [
        "001-Old Wasimi School Hall (Existing)",
        "002-Joke Taiwo Pry. School (Existing)",
        "003-Balogun Kuku Road (Existing)",
        "004-Otubu Memorial School (Existing)",
        "005-Iyanro Mosque (Existing)",
        "006-Oke Aje, Back of Ajayi’s House (Existing)",
        "007-Open Space at Moborode / Gbelegbuwa Junction (New)",
        "008-Open Space at Itapakura / Olode Junction (New)"
      ],
      "Ward-5": [
        "001-Front of Olisa’s Palace (Existing)",
        "002-Old Ijada Market (Existing)",
        "003-Omoluwabi Pry. School, Imepe (Existing)",
        "004-Moslem Pry. Sch., Imepe (Existing)",
        "005-U.N.A. Pry. Sch., Imepe (Existing)",
        "006-Orunse Area (Existing)",
        "007-Idomowo/Imose (Existing)",
        "008-Wasimi Pry. School (Existing)",
        "009-Idele (Existing)",
        "010-Ayeru/Ajegunle (Existing)",
        "011-Ipamuren Mosque (Existing)",
        "012-Beside Ramdat Hotel, Oguntuga St, Ijebu Ode (Existing)",
        "013-Open Space at Oya Junction by Adelaja Str. (New)",
        "014-Ajegunle / Ijada Street by Iya Adam Food Canteen (New)",
        "015-Open Space by Satina Hotel, Off Ondo Road (New)",
        "016-Open Space by Olorunosun / Satina Junction, Ondo Road (New)",
        "017-Open Space at Orunse – Jaginrin Junction, Imepe (New)",
        "018-Open Space at Alhaji Sodiq Street near Olatoye House by Cele (New)",
        "019-Cele T-Junction by Kowa Hospital, Off Ejinrin Road (New)",
        "020-Open Space Front of Bishop Court, Ejinrin Road (New)",
        "021-Caterpillar Junction, Adefisan Road, Off Ejinrin Road (New)",
        "022-Akintonde Plaza by Oyingbo Junction (New)",
        "023-Front of Halidu Mosque, Idele Junction (New)"
      ],
      "Ward-6": [
        "001-Muslem College (Existing)",
        "002-Opposite Apeloko (Existing)",
        "003-Opposite L.G. Works Dept. (Existing)",
        "004-Beside Isasa Mosque (Existing)",
        "005-Christ Church School, Molode (Existing)",
        "006-Ayegbami Wasimi Junction (Existing)",
        "007-Ojofa/Alapo Junction (Existing)",
        "008-Mobegelu St. (In front Olowu’s House) (Existing)",
        "009-Adeola Odutola College (Existing)",
        "010-Local Govt. Maternity Centre (Existing)",
        "011-Fidipote Adeola Junction (New)",
        "012-Open Space at Ayegbami Abass Street Junction (New)",
        "013-Open Space at Mukeke Junction by Moslem College Road (New)",
        "014-Open Space at Middle of Kaka Street, Tanimola Junction (New)",
        "015-Moslem Primary School, Molode (New)",
        "016-Open Space Agbaje Junction, by Transformer (New)",
        "017-Open Space at Alebiosu Street, Dupmos Junction (New)"
      ],
      "Ward-7": [
        "001-Front of Babalola’s House (Existing)",
        "002-Ijebu-Ode Grammar School (Existing)",
        "003-Christ Church Sch., Porogun (Existing)",
        "004-A.G.G.S., Obalende (Existing)",
        "005-Abeokuta Road, Front of Alowolodu (Existing)",
        "006-Ogbagba Street (Middle Front of Alawonle) (Existing)",
        "007-Italapo Mosque (Existing)",
        "008-Middle Alapo Street, (In front of Mosque) (Existing)",
        "009-Abeokuta Rd (In front of Olufowobi’s House) (Existing)",
        "010-Fisigboye – Ehindin Junction by Ijebu-Ode Local Government Secretariat (New)",
        "011-Open Space at Alatishe Mosque by Total Filling Station (New)",
        "012-Degun Junction, Obalende (New)",
        "013-Open Space Beside Obalende Police Station (New)",
        "014-Open Space by Ogunbule Junction, Olorunsogo (New)",
        "015-Open Space Lewu Junction Beside Seico House (New)",
        "016-Omosanya Olaonipekun Junction, Off Degun (New)",
        "017-Fidipote Junction, Off Fusigboye Road (New)",
        "018-Open Space at Alafia / Jaura Church Junction (New)"
      ],
      "Ward-8": [
        "001-Our Saviour’s Pry. School (Existing)",
        "002-Front of Bata Shop (Existing)",
        "003-Wesley School (Existing)",
        "004-C.A.C. School, Degun (Existing)",
        "005-Idepo Junction (Existing)",
        "006-Araromi/Iloro Junction (Existing)",
        "007-Odutola St. (Beside Odupele Street) (Existing)",
        "008-Molipa (In front Ogo-Oluwa Bakery) (Existing)",
        "009-Molipa High School (Existing)",
        "010-Odupele / Ogunyoku Junction (Existing)",
        "011-Osimore Junction (Existing)",
        "012-Open Space by Kenny Block Industry, Ilamo Area (New)",
        "013-Open Space by Ajiroba House (New)",
        "014-Open Space at Awoyemi Junction (New)",
        "015-Open Space at Alaiyepe Olugbile Junction, Molipa (New)",
        "016-Old Epic School / Cele Church Junction, Behind Prime Hotel (New)",
        "017-Open Space by Four Number Junction, Molipa Road (New)",
        "018-Open Space at Degun Junction by Onalaja Street, Off Folagbade Road (New)",
        "019-Open Space by Ogunba-Olasunbo Junction, Off Folagbade Road (New)",
        "020-Open Space by Zipest Filling Station, Opposite Soye Mosque (New)",
        "021-Ayesan Market Gate, Ayesan Area (New)",
        "022-Awoyelu-Jogbo Health Centre (New)",
        "023-Open Space at Lekuti Oke Junction (New)",
        "024-Open Space Opposite Mahdiyat Mosque, Idepo Street (New)",
        "025-Open Space Front of Ogun State Television, Ijebu Ode (New)",
        "026-Open Space at Osifeso/Odutola Street, Ijebu Ode (New)",
        "027-C.A.C. School, Degun (2) (New)",
        "028-C.A.C. Church by Post Office / C.M.S Bookshop, Folagbade (New)"
      ],
      "Ward-9": [
        "001-St. Augustine Catholic School (Existing)",
        "002-A.U.D. Pry. Sch. I, Bonojo (Existing)",
        "003-A.U.D. Pry. Sch. II, Onirugba (Existing)",
        "004-Govt. Technical College (Existing)",
        "005-Ezekiel Awoyelu Junction (Existing)",
        "006-Beside Ijebu-Ode Stadium (Existing)",
        "007-Tai Solarin College of Education (Existing)",
        "008-Old Odo Egbo Market (Existing)",
        "009-Ahmadiyya Mosque (Existing)",
        "010-K. Mansion (Existing)",
        "011-Igbeba / Elebute Junction (Existing)",
        "012-Bonjo / Odutola Street (Existing)",
        "013-GRA off Awujale Street (Middle) (Existing)",
        "014-End of Bonojo Eleruku (New)",
        "015-Olufowobi by Bonojo Four Junction (New)",
        "016-Mahdiyat Primary School (New)",
        "017-Adeben Place Hotel Junction, Igbeba (New)",
        "018-V.I.O Centre, Eruwon Road (New)",
        "019-Luba Comprehensive School, Off Erunwon Road (New)",
        "020-Open Space in front of Eid Praying Ground, Idobi (New)",
        "021-Open Space at New Road by Alafia Junction / Akiniganyin (New)"
      ],
      "Ward-10": [
        "001-Christ Church Pry. School – Isiwo (Existing)",
        "002-Ayeteju Maternity (Existing)",
        "003-Odo/Asoyin Pry. Sch. (Existing)",
        "004-Okelisa (Opposite New Mosque) (Existing)",
        "005-Odo Lofa (Existing)",
        "006-St. Patrick School, Isiwo (Existing)",
        "007-Ansarudeen High School, Isiwo (Existing)"
      ],
      "Ward-11": [
        "001-St. Alloysius School, Iloti (Existing)",
        "002-Odosengolu (Existing)",
        "003-Odo-Arewa Market (Existing)",
        "004-Okenla Tomoba Pry. Sch. (Existing)",
        "005-Local Government School, Idale (Existing)",
        "006-St. Joseph Odonoko (Existing)",
        "007-St. Joseph School, Odonoko (Existing)",
        "008-Oke-Ako (Existing)",
        "009-St. Anne’s School, Irawo (Existing)",
        "010-Tomoba Village (Existing)"
      ]
    }
  }
};

  // ====== DOM elements ======
  const stateEl = document.getElementById("state");
  const lgaEl = document.getElementById("lga");
  const wardEl = document.getElementById("ward");
  const unitEl = document.getElementById("unit");
  const lgaGroup = document.getElementById("lga-group");
  const wardGroup = document.getElementById("ward-group");
  const unitGroup = document.getElementById("unit-group");
  const biodataForm = document.getElementById("biodata-form");
  const dobEl = document.getElementById("dob");
  const ageEl = document.getElementById("age");
  const isVoterEl = document.getElementById("isVoter");
  const vinGroup = document.getElementById("vin-group");
  const vinEl = document.getElementById("vin");
  const isPartyEl = document.getElementById("isPartyMember");
  const partyIdGroup = document.getElementById("party-id-group");
  const regTime = document.getElementById("regTime");
  const timestampGroup = document.getElementById("timestamp-group");

  // ====== SheetDB endpoint ======
  const sheetDB_URL = "https://sheetdb.io/api/v1/ji8u767etbjge";

  // ====== Populate dropdowns ======
  stateEl.addEventListener("change", () => {
    const state = stateEl.value.toLowerCase();
    resetDropdown(lgaEl);
    resetDropdown(wardEl);
    resetDropdown(unitEl);
    hideElement(biodataForm);
    hideElement(wardGroup);
    hideElement(unitGroup);
    if (data[state]) {
      lgaGroup.classList.remove("hidden");
      for (let lga in data[state]) {
        const opt = document.createElement("option");
        opt.value = lga;
        opt.textContent = lga;
        lgaEl.appendChild(opt);
      }
    } else lgaGroup.classList.add("hidden");
  });

  lgaEl.addEventListener("change", () => {
    const state = stateEl.value.toLowerCase();
    const lga = lgaEl.value;
    resetDropdown(wardEl);
    resetDropdown(unitEl);
    hideElement(biodataForm);
    hideElement(unitGroup);
    if (data[state] && data[state][lga]) {
      wardGroup.classList.remove("hidden");
      for (let ward in data[state][lga]) {
        const opt = document.createElement("option");
        opt.value = ward;
        opt.textContent = ward;
        wardEl.appendChild(opt);
      }
    } else wardGroup.classList.add("hidden");
  });

  wardEl.addEventListener("change", () => {
    const state = stateEl.value.toLowerCase();
    const lga = lgaEl.value;
    const ward = wardEl.value;
    resetDropdown(unitEl);
    hideElement(biodataForm);
    if (data[state] && data[state][lga] && data[state][lga][ward]) {
      unitGroup.classList.remove("hidden");
      data[state][lga][ward].forEach(unit => {
        const opt = document.createElement("option");
        opt.value = unit;
        opt.textContent = unit;
        unitEl.appendChild(opt);
      });
    } else unitGroup.classList.add("hidden");
  });

  unitEl.addEventListener("change", () => {
    if (unitEl.value) biodataForm.classList.remove("hidden");
    else biodataForm.classList.add("hidden");
  });

  // ====== Age calculation ======
  dobEl.addEventListener("change", () => {
    if (!dobEl.value) {
      ageEl.value = "";
      return;
    }
    const dob = new Date(dobEl.value);
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
    ageEl.value = age;
  });

  // ====== VIN & Party toggles ======
  isVoterEl.addEventListener("change", () => {
    vinGroup.classList.toggle("hidden", isVoterEl.value !== "yes");
    if (isVoterEl.value !== "yes") vinEl.value = "";
  });

  isPartyEl.addEventListener("change", () => {
    partyIdGroup.classList.toggle("hidden", isPartyEl.value !== "yes");
    if (isPartyEl.value !== "yes") document.getElementById("partyId").value = "";
  });

  // ====== Admin timestamp ======
  document.addEventListener("DOMContentLoaded", () => {
    const isAdmin = true;
    if (isAdmin) {
      timestampGroup.classList.remove("hidden");
      regTime.value = new Date().toLocaleString();
    }
  });

  // ====== Utilities ======
  function resetDropdown(dropdown) {
    dropdown.innerHTML = '<option value="">-- Select --</option>';
  }
  function hideElement(el) {
    el.classList.add("hidden");
  }

  // ====== Form submit with VIN duplicate check ======
  biodataForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = {
      fullname: document.getElementById("fullname").value.trim(),
      phoneNumber: (() => {
        let rawPhone = document.getElementById("phone").value.trim();
        if (!rawPhone.startsWith("+234")) {
          rawPhone = "+234" + rawPhone.replace(/^0/, "");
        }
        return rawPhone;
      })(),
      address: document.getElementById("address").value.trim(),
      ward: wardEl.value,
      pollingUnit: unitEl.value,
      vin: vinEl.value.trim(),
      gender: document.getElementById("gender").value
    };

    // Basic validation
    const required = ["fullname", "phoneNumber", "address", "ward", "pollingUnit", "vin"];
    for (const id of required) {
      if (!formData[id]) {
        alert("Please fill in all required fields.");
        return;
      }
    }

    // VIN length check (optional, adjust if needed)
    if (formData.vin.length !== 19) {
      alert("VIN must be exactly 19 characters.");
      return;
    }

    try {
      // Check for duplicate VIN
      const checkRes = await fetch(`${sheetDB_URL}/search?vin=${encodeURIComponent(formData.vin)}`);
      if (!checkRes.ok) throw new Error("Failed to check VIN");

      const existing = await checkRes.json();

      if (existing.length > 0) {
        alert("This VIN has already been registered. Duplicate registrations are not allowed.");
        return;
      }

      // Submit new record
      const sheetPayload = { data: [formData] };
      const sheetRes = await fetch(sheetDB_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(sheetPayload)
      });

      if (!sheetRes.ok) throw new Error("SheetDB submission failed");

      alert("Member registered successfully!");
      e.target.reset();
      hideElement(biodataForm);
      resetDropdown(lgaEl);
      resetDropdown(wardEl);
      resetDropdown(unitEl);
      lgaGroup.classList.add("hidden");
      wardGroup.classList.add("hidden");
      unitGroup.classList.add("hidden");
    } catch (err) {
      console.error(err);
      alert("Error submitting data.");
    }
  });

  
